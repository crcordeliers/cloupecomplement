---
title: "loupeBrowserComplementaryAnalyses"
author: "Nicolas Salaun"
date: "2024-09-16"
output: html_document
---

This Script shouldn't be touched other than the variable loading section (2nd code chunk). If you think you made a change that wasn't desired, just close the script without saving it. Once you've made your desired changes (filename / genes of interest ...) simply click "Run" \> "Run All" in the top right corner of this tab, or press Ctrl+Alt+R.

Load the required libraries to make the script work -- DO NOT MODIFY--

```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(ggplot2, Seurat, reshape2, ggbeeswarm, dplyr)
```

Load the variables required -- MODIFY WITH YOUR INPUTS HERE --

```{r}
#Here it should be the path to the folder named outs given in the CellRanger output
filenameCellRangerOuts <- "/home/nsalaun/CARPEM/CHICS/outs"
#Put here the CSV file output you got from Loupe Browser
filenameCluster <- "/home/nsalaun/CARPEM/CHICS/K-Means 7.csv"
#Here, put the desired genes that you want to plot as violin plots / beeswarm
genesOfInterest <- c("ADH1C", "NUPR1", "C2")
#Here, specify where the plots should be saved
outputPath <- "/home/nsalaun/CARPEM/CHICS/plots"
```

## -- DO NOT MODIFY ANYTHING BELOW THIS --

Load the data

```{r}
seuratObj <- Load10X_Spatial(filenameCellRangerOuts)
clusterMat <- read.csv2(filenameCluster, sep = ",")
```

Filter out low-expressed genes

```{r}
percent_expressed <- rowSums(seuratObj[["Spatial"]]$counts > 0) / ncol(seuratObj) * 100
# Keep genes expressed in at least 1% of cells
genes_to_keep <- names(percent_expressed[percent_expressed >= 1])
seuratObj <- subset(seuratObj, features = genes_to_keep)
```

Normalize the data

```{r}
seuratObj <- NormalizeData(seuratObj, normalization.method = "LogNormalize")
countMatrix <- seuratObj[["Spatial"]]$data
# Applying SCTransform normalization
# seuratObj <- SCTransform(seuratObj, assay = "Spatial", verbose = FALSE)
# countMatrix <- as.matrix(GetAssay(seuratObj, assay="SCT")$data)
```

Check the alignment of the Barcodes between the clusterMat and Countmatrix

```{r}
barcodes <- colnames(countMatrix)
clusterMat <- clusterMat[clusterMat$Barcode %in% barcodes,]
```

Create the violin and Beeswarm plots

```{r}
for (gene in genesOfInterest) {
  #Prepare the data for plotting
  gene_data <- data.frame(
    Expression = countMatrix[gene, ], 
    Barcode = colnames(countMatrix),
    Cluster = clusterMat[,2]
  )
  
  violin_plot <- ggplot(gene_data, aes(x = Cluster, y = Expression)) +
      geom_violin(aes(fill = Cluster), trim = TRUE) +
      geom_boxplot(fill = "gray", width=0.05, outliers = FALSE, show.legend = FALSE) +
      theme_minimal() +
      labs(title = paste("Violin Plot for", gene), x = "Cluster", y = "Expression Level")
    
    # Beeswarm plot
  beeswarm_plot <- ggplot(gene_data, aes(x = Cluster, y = Expression)) +
    geom_quasirandom(aes(color = Cluster), size = 0.8, stroke = 0.3, width = 0.5) +
    geom_boxplot(fill = "gray", width=0.05, outliers = FALSE, show.legend = FALSE) +
    guides(color = guide_legend(override.aes = list(size = 4))) +
    labs(title = paste("Beeswarm Plot for", gene), x = "Cluster", y = "Expression Level")
  print(violin_plot)
  print(beeswarm_plot)
}
```
